# Composer 组件录音与语音识别功能使用说明

## 功能概述

Composer 组件支持点击语音图标进行录音，并自动将录音转化为文字发送给小助手。

### 核心功能

1. **录音功能**：使用浏览器的 MediaRecorder API 录制音频
2. **语音识别**：使用 Web Speech API 实时将语音转为文字
3. **自动发送**：录音结束后，自动将识别出的文字作为消息发送

### 技术实现

- **录音**：MediaRecorder API
- **语音识别**：Web Speech Recognition API (支持中文)
- **实时识别**：持续识别，录音过程中实时转换语音为文字

## 使用方法

### 基本使用

```vue
<template>
  <Composer
    v-model="message"
    :show-voice="true"
    @send="handleSend"
    @voice-start="handleVoiceStart"
    @voice-end="handleVoiceEnd"
    @voice-cancel="handleVoiceCancel"
    @voice-error="handleVoiceError"
  />
</template>

<script setup>
import { ref } from "vue";
import Composer from "@/components/Composer/index.vue";

const message = ref("");

// 处理发送消息（包括语音转文字后的自动发送）
const handleSend = (text) => {
  console.log("收到消息:", text);
  // 将消息添加到聊天列表
  // messages.value.push({ text, type: 'user' });
};

// 开始录音
const handleVoiceStart = () => {
  console.log("开始录音");
};

// 录音完成
const handleVoiceEnd = (audioData) => {
  console.log("录音完成", audioData);
  console.log("识别出的文字:", audioData.text);
  // audioData 包含：
  // - file: 音频文件对象
  // - blob: 音频 Blob 对象
  // - duration: 录音时长（秒）
  // - url: 音频 URL（可用于预览）
  // - text: 识别出的文字
};

// 取消录音
const handleVoiceCancel = () => {
  console.log("取消录音");
};

// 录音错误
const handleVoiceError = (error) => {
  console.error("录音错误:", error);
};
</script>
```

## 事件说明

### send

发送消息时触发（包括语音识别后的自动发送）。

**参数**：

- `text` (String): 消息文本内容

### voiceStart

开始录音时触发，无参数。

### voiceEnd

录音完成时触发，参数为音频数据对象：

| 属性     | 类型   | 说明                                |
| -------- | ------ | ----------------------------------- |
| file     | File   | 音频文件对象，可直接上传            |
| blob     | Blob   | 音频 Blob 对象                      |
| duration | String | 录音时长（秒），如 "3.5"            |
| url      | String | 音频 URL，可用于 `<audio>` 标签播放 |
| text     | String | 识别出的文字内容                    |

**重要**：录音结束后，如果成功识别出文字，会自动触发 `send` 事件发送消息。

### voiceCancel

取消录音时触发，无参数。

### voiceError

录音出错时触发，参数为错误对象：

| 属性    | 类型   | 说明                 |
| ------- | ------ | -------------------- |
| type    | String | 错误类型             |
| message | String | 错误信息             |
| error   | Error  | 原始错误对象（可选） |

**常见错误类型**：

- `not_supported`: 浏览器不支持录音功能
- `NotAllowedError`: 用户拒绝麦克风权限
- `NotFoundError`: 未找到麦克风设备

## 功能特性

1. **实时语音识别**：录音过程中实时将语音转为文字
2. **自动发送**：识别出文字后自动发送，无需手动输入
3. **权限管理**：首次录音会请求麦克风权限
4. **时长限制**：录音时长不得少于 1 秒
5. **视觉反馈**：
   - 录音中图标变为红色
   - 添加脉冲动画效果
   - 添加波纹扩散效果
6. **格式兼容**：优先使用 webm 格式，不支持时自动降级到 mp4
7. **资源清理**：组件卸载时自动清理录音和识别资源
8. **中文支持**：语音识别默认使用中文（zh-CN）

## 操作流程

1. 点击语音图标开始录音
2. 录音中：
   - 图标显示红色并有动画效果
   - 语音识别在后台持续运行
   - 实时将语音转换为文字
3. 再次点击图标停止录音
4. 录音结束：
   - 如果识别出文字：自动发送消息
   - 如果未识别到文字：提示"未识别到文字"
5. 触发 `voiceEnd` 事件，传递音频数据和识别文字

## 浏览器兼容性

### 录音功能

- Chrome/Edge: ✅ 完全支持
- Firefox: ✅ 完全支持
- Safari: ✅ 需要 iOS 14.3+ / macOS 11+

### 语音识别

- Chrome/Edge: ✅ 完全支持（使用 Web Speech API）
- Firefox: ❌ 不支持（仅保存录音，不识别文字）
- Safari: ⚠️ 部分支持（iOS 14.5+ / macOS 11.4+）

**注意**：如果浏览器不支持语音识别，录音功能仍然可用，只是不会自动转换为文字。

## 注意事项

1. **HTTPS 要求**：录音和语音识别功能需要在 HTTPS 环境或 localhost 下才能使用
2. **权限管理**：首次使用需要用户授予麦克风权限
3. **时长要求**：录音时长至少需要 1 秒
4. **资源释放**：录音完成后返回的 URL 需要在使用完后手动释放：`URL.revokeObjectURL(url)`
5. **网络要求**：语音识别可能需要网络连接（取决于浏览器实现）
6. **语言设置**：当前默认为中文识别，如需其他语言可修改 `recognitionInstance.lang`

## 示例效果

```
用户操作：点击语音图标 → 说话 "你好，今天天气怎么样" → 再次点击图标

系统行为：
1. 显示 "开始录音..." 提示
2. 录音中图标变红，有动画效果
3. 后台实时识别语音
4. 显示 "录音完成，正在发送..." 提示
5. 自动发送消息 "你好，今天天气怎么样"
6. 小助手收到消息并回复
```

## 故障排查

### 问题 1：提示"请允许访问麦克风权限"

**解决方案**：在浏览器地址栏点击麦克风图标，允许权限

### 问题 2：提示"未找到麦克风设备"

**解决方案**：检查电脑是否连接麦克风，或检查系统设置中麦克风是否启用

### 问题 3：录音正常但未识别到文字

**可能原因**：

- 浏览器不支持语音识别（如 Firefox）
- 语音识别服务连接失败
- 录音环境噪音过大

**解决方案**：

- 使用 Chrome/Edge 浏览器
- 检查网络连接
- 在安静环境下录音

### 问题 4：提示"录音时间太短"

**解决方案**：录音至少需要持续 1 秒以上
