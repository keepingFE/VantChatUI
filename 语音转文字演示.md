# 语音转文字功能演示

## 功能说明

录音完成后，系统会自动将语音转化为文字并发送给小助手。

## 使用步骤

### 1. 点击录音按钮

点击左侧的 🔊 语音图标开始录音

### 2. 开始说话

- 录音图标会变成红色
- 图标会有呼吸动画效果
- 周围有红色波纹扩散
- 后台正在进行实时语音识别

### 3. 停止录音

再次点击语音图标停止录音

### 4. 自动发送

- 如果识别出文字：自动发送消息
- 如果未识别到：提示"未识别到文字"

## 实现原理

```
┌──────────────┐
│  点击录音按钮 │
└──────┬───────┘
       │
       ▼
┌────────────────────────┐
│  1. 请求麦克风权限      │
│  2. 开始录音            │
│  3. 启动语音识别        │
└──────┬─────────────────┘
       │
       ▼
┌────────────────────────┐
│  录音中...              │
│  - 收集音频数据         │
│  - 实时识别语音         │
│  - 将语音转为文字       │
└──────┬─────────────────┘
       │
       ▼
┌────────────────────────┐
│  点击停止录音           │
└──────┬─────────────────┘
       │
       ▼
┌────────────────────────┐
│  1. 停止录音            │
│  2. 停止语音识别        │
│  3. 获取识别文字        │
└──────┬─────────────────┘
       │
       ▼
┌────────────────────────┐
│  识别出文字？           │
└──┬───────────┬─────────┘
   │Yes        │No
   ▼           ▼
┌─────────┐ ┌──────────────┐
│自动发送  │ │提示未识别到   │
└─────────┘ └──────────────┘
```

## 技术栈

- **录音**: MediaRecorder API
- **语音识别**: Web Speech Recognition API
- **语言**: 中文 (zh-CN)
- **模式**: 持续识别 (continuous)

## 代码实现

### Composer 组件核心代码

```javascript
// 初始化语音识别
const SpeechRecognition =
  window.SpeechRecognition || window.webkitSpeechRecognition;
const recognitionInstance = new SpeechRecognition();

// 配置
recognitionInstance.continuous = true; // 持续识别
recognitionInstance.interimResults = true; // 返回临时结果
recognitionInstance.lang = "zh-CN"; // 中文识别

// 监听识别结果
recognitionInstance.onresult = (event) => {
  for (let i = event.resultIndex; i < event.results.length; i++) {
    const transcript = event.results[i][0].transcript;
    if (event.results[i].isFinal) {
      recognizedText.value += transcript; // 保存最终结果
    }
  }
};

// 开始识别
recognitionInstance.start();

// 停止录音时
const text = recognizedText.value.trim();
if (text) {
  emit("send", text); // 自动发送识别出的文字
}
```

### App.vue 处理发送

```javascript
const handleSend = (text) => {
  // 1. 添加用户消息
  const userMsg = {
    _id: `${Date.now()}_${Math.random()}`,
    type: "text",
    content: text,
    position: "right",
    user: currentUser,
  };
  messages.value.push(userMsg);

  // 2. 小助手回复...
};
```

## 测试方法

### 方法 1: 本地测试

```bash
# 启动开发服务器
npm run dev

# 打开浏览器，点击录音按钮
# 说话测试，例如："你好，今天天气怎么样"
```

### 方法 2: 控制台查看

打开浏览器控制台，可以看到详细日志：

```
[语音] 开始录音
[语音] 录音完成 {duration: "3.5秒", recognizedText: "你好，今天天气怎么样", hasAudio: true}
```

## 注意事项

### 浏览器要求

- ✅ Chrome/Edge (推荐)
- ⚠️ Safari (iOS 14.5+ / macOS 11.4+)
- ❌ Firefox (不支持语音识别)

### 环境要求

- 必须在 HTTPS 或 localhost 环境
- 需要麦克风权限
- 建议在安静环境测试

### 常见问题

**Q: 点击后没反应？**
A: 检查浏览器是否授予麦克风权限

**Q: 录音正常但没有文字？**
A:

- 检查是否使用 Chrome/Edge 浏览器
- 检查网络连接
- 尝试说话更清晰

**Q: 识别不准确？**
A:

- 在安静环境录音
- 说话清晰、语速适中
- 避免方言，使用普通话

**Q: 录音立即结束？**
A: 录音至少需要持续 1 秒

## 效果展示

### 成功场景

```
[用户操作] 点击录音 → 说"你好" → 停止录音
[系统提示] "开始录音..." → "录音完成，正在发送..."
[消息列表] 显示 "你好"（用户消息）
[AI回复] "收到你的消息: "你好""
```

### 失败场景

```
[用户操作] 点击录音 → 不说话 → 停止录音
[系统提示] "开始录音..." → "录音完成，未识别到文字"
[消息列表] 无新消息
```

## 扩展功能建议

1. **多语言支持**：切换识别语言（英文、日文等）
2. **音频保存**：将录音文件上传到服务器
3. **离线识别**：集成离线语音识别引擎
4. **实时显示**：录音过程中显示识别的临时结果
5. **语音命令**：支持特定语音命令（如"发送"、"取消"）

## 相关文档

- [录音功能使用说明](./录音功能使用说明.md)
- [Web Speech API 文档](https://developer.mozilla.org/en-US/docs/Web/API/Web_Speech_API)
- [MediaRecorder API 文档](https://developer.mozilla.org/en-US/docs/Web/API/MediaRecorder)
